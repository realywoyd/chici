<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ö–∏–±–µ—Ä-–ì–æ—Ä–æ–¥ 2089 - Telegram Mini App</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #0d0d1a;
            color: #00ffcc;
            font-family: 'Courier New', monospace;
            touch-action: none; /* –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ */
        }
        #game-ui {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 200px;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border: 1px solid #ff00ff;
            font-size: 12px;
        }
        .neon-text {
            text-shadow: 0 0 5px #00ffcc, 0 0 10px #ff00ff;
        }
        button {
            background: #ff00ff;
            color: #00ffcc;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            font-size: 10px;
        }
        button:hover {
            background: #00ffcc;
            color: #ff00ff;
        }
        #output {
            height: 60px;
            overflow-y: auto;
            border: 1px dashed #00ffcc;
            padding: 5px;
        }
        .notification {
            padding: 3px;
            margin: 2px 0;
            transition: opacity 0.5s ease-out;
        }
        .notification.fade-out {
            opacity: 0;
        }
        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 80px;
            height: 80px;
            background: rgba(255, 0, 255, 0.2);
            border-radius: 50%;
            touch-action: none;
        }
        #joystick-knob {
            width: 40px;
            height: 40px;
            background: #00ffcc;
            border-radius: 50%;
            position: absolute;
            top: 20px;
            left: 20px;
        }
    </style>
</head>
<body>
    <div id="game-ui">
        <h1 class="neon-text">üåÉ –ö–∏–±–µ—Ä-–ì–æ—Ä–æ–¥</h1>
        <div id="output">
            –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!<br>–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:<br>
        </div>
        <div id="create-character">
            <input id="char-name" type="text" placeholder="–ò–º—è" style="width: 80px; background: #1a1a33; color: #00ffcc; border: 1px solid #ff00ff; padding: 2px;">
            <button onclick="createCharacter('–•–∞–∫–µ—Ä')">–•–∞–∫–µ—Ä</button>
            <button onclick="createCharacter('–ù–∞–µ–º–Ω–∏–∫')">–ù–∞–µ–º–Ω–∏–∫</button>
            <button onclick="createCharacter('–¢–µ—Ö–Ω–∏–∫')">–¢–µ—Ö–Ω–∏–∫</button>
        </div>
        <div id="character-list"></div>
        <div id="action-buttons" style="display: none;">
            <button onclick="startMission()">–ú–∏—Å—Å–∏—è</button>
            <button onclick="completeMission()">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
        </div>
    </div>
    <div id="joystick">
        <div id="joystick-knob"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <!-- Telegram Web Apps SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Telegram Web Apps –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.Telegram.WebApp.ready();
        window.Telegram.WebApp.expand();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ü–µ–Ω—ã
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "low-power" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        document.body.appendChild(renderer.domElement);

        // –û—Å–≤–µ—â–µ–Ω–∏–µ
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
        scene.add(ambientLight);
        const neonLight = new THREE.PointLight(0xff00ff, 1, 30);
        neonLight.position.set(0, 10, 0);
        scene.add(neonLight);

        // –ó–µ–º–ª—è
        const groundGeometry = new THREE.PlaneGeometry(50, 50);
        const groundMaterial = new THREE.MeshBasicMaterial({ color: 0x1a1a33 });
        const ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        scene.add(ground);

        // –ó–¥–∞–Ω–∏—è (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
        const buildingMaterial = new THREE.MeshBasicMaterial({ color: 0x00ffcc });
        for (let i = 0; i < 10; i++) {
            const height = Math.random() * 10 + 5;
            const building = new THREE.Mesh(new THREE.BoxGeometry(3, height, 3), buildingMaterial);
            building.position.set(Math.random() * 40 - 20, height / 2, Math.random() * 40 - 20);
            scene.add(building);
        }

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentCharacter = null;
        const characters = [];
        let selectedCharacter = null;
        const output = document.getElementById("output");
        const actionButtons = document.getElementById("action-buttons");
        const createCharacterDiv = document.getElementById("create-character");
        let currentMission = null;

        // –ö–∞–º–µ—Ä–∞
        camera.position.set(0, 8, 10);

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function createCharacterModel(role) {
            if (currentCharacter) scene.remove(currentCharacter);
            const group = new THREE.Group();
            let color = role === "–•–∞–∫–µ—Ä" ? 0x00ffcc : role === "–ù–∞–µ–º–Ω–∏–∫" ? 0xff00ff : 0xffff00;
            const material = new THREE.MeshBasicMaterial({ color });

            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 1.2, 8), material);
            body.position.y = 0.6;
            group.add(body);

            const head = new THREE.Mesh(new THREE.SphereGeometry(0.25, 8, 8), material);
            head.position.y = 1.3;
            group.add(head);

            currentCharacter = group;
            currentCharacter.position.set(0, 0, 0);
            scene.add(currentCharacter);
        }

        // –î–∂–æ–π—Å—Ç–∏–∫
        const joystick = document.getElementById("joystick");
        const knob = document.getElementById("joystick-knob");
        let joystickActive = false;
        let joystickOrigin = { x: 0, y: 0 };
        let direction = { x: 0, y: 0 };

        joystick.addEventListener("touchstart", (e) => {
            e.preventDefault();
            joystickActive = true;
            const touch = e.touches[0];
            joystickOrigin = { x: touch.clientX, y: touch.clientY };
        });

        joystick.addEventListener("touchmove", (e) => {
            e.preventDefault();
            if (!joystickActive || !currentCharacter) return;
            const touch = e.touches[0];
            const dx = touch.clientX - joystickOrigin.x;
            const dy = touch.clientY - joystickOrigin.y;
            const distance = Math.min(40, Math.sqrt(dx * dx + dy * dy));
            const angle = Math.atan2(dy, dx);
            direction.x = Math.cos(angle) * (distance / 40);
            direction.y = Math.sin(angle) * (distance / 40);
            knob.style.left = `${20 + Math.cos(angle) * distance}px`;
            knob.style.top = `${20 + Math.sin(angle) * distance}px`;
        });

        joystick.addEventListener("touchend", () => {
            joystickActive = false;
            direction = { x: 0, y: 0 };
            knob.style.left = "20px";
            knob.style.top = "20px";
        });

        // –ê–Ω–∏–º–∞—Ü–∏—è
        function animate() {
            requestAnimationFrame(animate);

            if (currentCharacter) {
                const speed = 0.05;
                currentCharacter.position.x += direction.x * speed;
                currentCharacter.position.z += direction.y * speed;

                if (direction.x !== 0 || direction.y !== 0) {
                    currentCharacter.rotation.y = Math.atan2(direction.x, direction.y);
                    currentCharacter.children[0].rotation.z = Math.sin(Date.now() * 0.01) * 0.1;
                }

                camera.position.set(
                    currentCharacter.position.x,
                    currentCharacter.position.y + 8,
                    currentCharacter.position.z + 10
                );
                camera.lookAt(currentCharacter.position);
            }

            renderer.render(scene, camera);
        }
        animate();

        // –õ–æ–≥–∏–∫–∞ –∏–≥—Ä—ã
        function appendMessage(text) {
            const message = document.createElement("div");
            message.className = "notification";
            message.innerHTML = text;
            output.appendChild(message);
            output.scrollTop = output.scrollHeight;
            setTimeout(() => {
                message.classList.add("fade-out");
                setTimeout(() => message.remove(), 500);
            }, 2000);
        }

        function createCharacter(role) {
            if (characters.length >= 3) {
                appendMessage("–ú–∞–∫—Å–∏–º—É–º 3 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!");
                return;
            }
            const name = document.getElementById("char-name").value.trim();
            if (!name) {
                appendMessage("–í–≤–µ–¥–∏ –∏–º—è!");
                return;
            }
            const character = {
                name,
                role,
                creds: 0,
                stats: {
                    strength: role === "–ù–∞–µ–º–Ω–∏–∫" ? 10 : 5,
                    intelligence: role === "–•–∞–∫–µ—Ä" ? 10 : 5,
                    agility: role === "–¢–µ—Ö–Ω–∏–∫" ? 10 : 5
                }
            };
            characters.push(character);
            document.getElementById("char-name").value = "";
            updateCharacterList();
            appendMessage(`–°–æ–∑–¥–∞–Ω: ${name} (${role}).`);
            if (characters.length === 3) createCharacterDiv.style.display = "none";
            window.Telegram.WebApp.showAlert(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${name} —Å–æ–∑–¥–∞–Ω!`);
        }

        function updateCharacterList() {
            const charList = document.getElementById("character-list");
            charList.innerHTML = "<h3>–ü–µ—Ä—Å–æ–Ω–∞–∂–∏:</h3>";
            characters.forEach((char, index) => {
                charList.innerHTML += `
                    <button onclick="selectCharacter(${index})">
                        ${char.name} (${char.role}) - ${char.creds} –∫—Ä.
                    </button><br>`;
            });
        }

        function selectCharacter(index) {
            selectedCharacter = characters[index];
            createCharacterModel(selectedCharacter.role);
            appendMessage(`–í—ã–±—Ä–∞–Ω: ${selectedCharacter.name}.`);
            actionButtons.style.display = "block";
            currentMission = null;
        }

        function startMission() {
            if (!selectedCharacter) {
                appendMessage("–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!");
                return;
            }
            const missions = {
                "–•–∞–∫–µ—Ä": [
                    { target: [-5, -5], reward: 50, desc: "–í–∑–ª–æ–º–∞—Ç—å —Ç–µ—Ä–º–∏–Ω–∞–ª" },
                    { target: [7, -7], reward: 75, desc: "–í–∑–ª–æ–º–∞—Ç—å —Å–µ—Ä–≤–µ—Ä" }
                ],
                "–ù–∞–µ–º–Ω–∏–∫": [
                    { target: [5, 5], reward: 70, desc: "–£–Ω–∏—á—Ç–æ–∂–∏—Ç—å –¥—Ä–æ–Ω–∞" },
                    { target: [-7, 7], reward: 100, desc: "–õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Ü–µ–ª—å" }
                ],
                "–¢–µ—Ö–Ω–∏–∫": [
                    { target: [0, 5], reward: 60, desc: "–ü–æ—á–∏–Ω–∏—Ç—å –¥—Ä–æ–Ω" },
                    { target: [5, -5], reward: 90, desc: "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —ç–Ω–µ—Ä–≥–æ–±–ª–æ–∫" }
                ]
            };
            const missionList = missions[selectedCharacter.role];
            currentMission = missionList[Math.floor(Math.random() * missionList.length)];
            appendMessage(`–¶–µ–ª—å: ${currentMission.desc}. –ò–¥–∏ –∫ (${currentMission.target[0]}, ${currentMission.target[1]}).`);
        }

        function completeMission() {
            if (!selectedCharacter || !currentCharacter) {
                appendMessage("–í—ã–±–µ—Ä–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!");
                return;
            }
            if (!currentMission) {
                appendMessage("–ù–∞—á–Ω–∏ –º–∏—Å—Å–∏—é!");
                return;
            }
            const pos = currentCharacter.position;
            const [targetX, targetZ] = currentMission.target;
            if (Math.abs(pos.x - targetX) < 1 && Math.abs(pos.z - targetZ) < 1) {
                selectedCharacter.creds += currentMission.reward;
                appendMessage(`‚ö°Ô∏è ${currentMission.desc}: +${currentMission.reward} –∫—Ä.`);
                window.Telegram.WebApp.showAlert(`–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! +${currentMission.reward} –∫—Ä–µ–¥–∏—Ç–æ–≤`);
            } else {
                appendMessage("üí• –ù–µ –≤ —Ç–æ—á–∫–µ!");
                return;
            }
            updateCharacterList();
            currentMission = null;
        }

        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
